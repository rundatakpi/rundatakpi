<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cn.run.kpi.estimate.dao.TransformDao">
  
    
    <sql id="transCondition">
        <if test="null != dataSourceCode and '' != dataSourceCode">
            and sourcecode = #{dataSourceCode}
        </if>
        <if test="null != bProtocolCode and '' != bProtocolCode">
            and bigaggrecode = #{bProtocolCode}
        </if>
        <if test="null != sProtocolCode and '' != sProtocolCode">
            and smallaggrecode = #{sProtocolCode}
        </if>
        <if test="null != actionType and '' != actionType">
            and actiontype = #{actionType}
        </if>
        <if test="null != startTime and '' != startTime">
            and createTime <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="null != endTime and '' != endTime">
            and createTime <![CDATA[ < ]]> #{endTime}
        </if>
    </sql>
    
	<select id="getList" parameterType="com.cn.run.kpi.estimate.entity.TransformData" resultType="com.cn.run.kpi.estimate.entity.TransformData">
		select 
			t.sourcecode dataSourceCode,
			t.sourcedesc dataSourceDescription,
			t.bigaggrecode bProtocolCode,
			t.bigaggredesc bProtocolDescription,
			t.smallaggrecode sProtocolCode,
			t.smallaggredesc sProtocolDescription,
			t.actiontype actionType,
			floor(sum(t.input_count)) inputDataNum,
			floor(avg(t.inputspeed)) inputDataSpeed,
			floor(avg(t.inputfieldfillrage)) inputFieldFillRate,
			floor(avg(t.inputrelyfieldfillrage)) inputDependGroupFillRate,
			floor(avg(t.inputfielduserage)) inputFieldAvailability,
			floor(avg(t.inputrelyfielduserage)) inputDependGroupAvailability,
			floor(avg(t.inputaccuracyrage)) inputDataAccuracy
		from tran_data t
		<where>
			<include refid="transCondition"></include>
		</where>
		group by 
			t.sourcecode,
			t.bigaggrecode,
			t.smallaggrecode,
			t.actiontype
		limit #{start},#{length}
	</select>
	
	<select id="getTotal" parameterType="com.cn.run.kpi.estimate.entity.TransformData" resultType="java.lang.Integer">
		SELECT count(
				DISTINCT t.sourcecode,
				t.bigaggrecode,
				t.smallaggrecode,
				t.actiontype
			)
		FROM tran_data t 
		<where>
			<include refid="transCondition"></include>
		</where>
	</select>
	
	<select id="selectDetail" parameterType="com.cn.run.kpi.estimate.entity.TransformData" resultType="com.cn.run.kpi.estimate.entity.TransformData">
		select createtime as transKey,${colName} as transValue from tran_data
		<where>
			<include refid="transCondition"></include>
		</where>
		
	</select>
</mapper>